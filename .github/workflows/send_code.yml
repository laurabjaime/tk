name: Send Python Code to API

on:
  push:
    branches:
      - main  # Executa quando há um merge para main

jobs:
  send_code_to_api:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Debug - Verificar API Key
        run: |
          if [ -z "${{ secrets.API_KEY }}" ]; then
            echo "Erro: API_KEY não está configurada no GitHub Secrets!"
            exit 1
          else
            echo "API_KEY foi carregada corretamente!"
          fi

      - name: Ler código dos arquivos Python e armazenar como string
        run: |
          SUMMARIZE_CODE=$(awk '{printf "%s\\n", $0}' summarize.py | paste -sd '' | sed 's/\\\\n/\\n/g' | sed 's/\n/\\n/g')
          MULTIPLY_CODE=$(awk '{printf "%s\\n", $0}' multiply.py | paste -sd '' | sed 's/\\\\n/\\n/g' | sed 's/\n/\\n/g')

          # Se as variáveis estiverem vazias, definir valor padrão
          if [ -z "$SUMMARIZE_CODE" ]; then SUMMARIZE_CODE="print('Erro: código não encontrado')"; fi
          if [ -z "$MULTIPLY_CODE" ]; then MULTIPLY_CODE="print('Erro: código não encontrado')"; fi

          echo "SUMMARIZE_CODE=${SUMMARIZE_CODE}" >> $GITHUB_ENV
          echo "MULTIPLY_CODE=${MULTIPLY_CODE}" >> $GITHUB_ENV
        
      - name: Debug - Verificar variáveis antes do envio
        run: |
          echo "SUMMARIZE_CODE: ${{ env.SUMMARIZE_CODE }}"
          echo "MULTIPLY_CODE: ${{ env.MULTIPLY_CODE }}"

      - name: Verificar se variáveis não estão vazias
        run: |
          if [ -z "${{ env.SUMMARIZE_CODE }}" ]; then
            echo "Erro: SUMMARIZE_CODE está vazio!"
            exit 1
          fi

          if [ -z "${{ env.MULTIPLY_CODE }}" ]; then
            echo "Erro: MULTIPLY_CODE está vazio!"
            exit 1
          fi

      # - name: Ler código dos arquivos Python e armazenar como string
      #   run: |
      #     SUMMARIZE_CODE=$(awk '{printf "%s\\n", $0}' summarize.py | paste -sd '' | sed 's/\\\\n/\\n/g' | sed 's/\n/\\n/g')
      #     MULTIPLY_CODE=$(awk '{printf "%s\\n", $0}' multiply.py | paste -sd '' | sed 's/\\\\n/\\n/g' | sed 's/\n/\\n/g')

      #     echo "SUMMARIZE_CODE=${SUMMARIZE_CODE}" >> $GITHUB_ENV
      #     echo "MULTIPLY_CODE=${MULTIPLY_CODE}" >> $GITHUB_ENV

      - name: Enviar código para API
        run: |
          python - <<EOF
          import http.client
          import json
          import os

          conn = http.client.HTTPSConnection("eu-central-1.taktile-org.decide.taktile.com")

          headers = {
              "X-Api-Key": os.getenv("API_KEY"),
              "accept": "application/json",
              "Content-Type": "application/json"
          }

          summarize_code = os.getenv("SUMMARIZE_CODE")
          multiply_code = os.getenv("MULTIPLY_CODE")

          if not summarize_code or summarize_code.strip() == "":
              raise ValueError("Erro: SUMMARIZE_CODE está vazio!")

          if not multiply_code or multiply_code.strip() == "":
              raise ValueError("Erro: MULTIPLY_CODE está vazio!")

          summarize_payload = json.dumps({
              "data": {
                  "flow_id": "06457ab1-3367-43c3-9e6b-4dbaa88d1b1b",
                  "node_id": "affc68e2-f4e7-40b2-a8e4-4f08ac9cc643",
                  "src_code": summarize_code
              },
              "metadata": {
                  "version": "v1.0",
                  "entity_id": "string"
              },
              "control": {
                  "execution_mode": "sync"
              }
          })

          multiply_payload = json.dumps({
              "data": {
                  "flow_id": "06457ab1-3367-43c3-9e6b-4dbaa88d1b1b",
                  "node_id": "affc68e2-f4e7-40b2-a8e4-4f08ac9cc123",
                  "src_code": multiply_code
              },
              "metadata": {
                  "version": "v1.0",
                  "entity_id": "string"
              },
              "control": {
                  "execution_mode": "sync"
              }
          })

          # Enviar SUMMARIZE_CODE
          conn.request("POST", "/run/api/v1/flows/patch-decision-graph/sandbox/decide", summarize_payload, headers)
          res = conn.getresponse()
          print("Summarize response:", res.status, res.read().decode("utf-8"))

          # Enviar MULTIPLY_CODE
          conn.request("POST", "/run/api/v1/flows/patch-decision-graph/sandbox/decide", multiply_payload, headers)
          res = conn.getresponse()
          print("Multiply response:", res.status, res.read().decode("utf-8"))
          EOF
